-- Ship, Crew, and Outpost Tracking System Migration\n-- Updated to handle existing tables from init.sql\n\n-- Create ships table only if it doesn't exist\nCREATE TABLE IF NOT EXISTS ships (\n    id SERIAL PRIMARY KEY,\n    name VARCHAR(255) NOT NULL,\n    location VARCHAR(255),\n    is_squibbing BOOLEAN DEFAULT false,\n    damage INTEGER DEFAULT 0,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- Create outposts table only if it doesn't exist\nCREATE TABLE IF NOT EXISTS outposts (\n    id SERIAL PRIMARY KEY,\n    name VARCHAR(255) NOT NULL,\n    location VARCHAR(255),\n    access_date DATE,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- Create crew table only if it doesn't exist\nCREATE TABLE IF NOT EXISTS crew (\n    id SERIAL PRIMARY KEY,\n    name VARCHAR(255) NOT NULL,\n    race VARCHAR(100),\n    age INTEGER,\n    description TEXT,\n    location_type VARCHAR(20), -- 'ship' or 'outpost'\n    location_id INTEGER, -- references ships.id or outposts.id\n    ship_position VARCHAR(100), -- captain, first mate, etc (null if at outpost)\n    is_alive BOOLEAN DEFAULT true,\n    death_date DATE,\n    departure_date DATE,\n    departure_reason TEXT,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- Create indexes only if they don't exist\nCREATE INDEX IF NOT EXISTS idx_crew_location ON crew(location_type, location_id);\nCREATE INDEX IF NOT EXISTS idx_crew_is_alive ON crew(is_alive);\nCREATE INDEX IF NOT EXISTS idx_crew_ship_position ON crew(ship_position);\n\n-- Add constraint only if it doesn't exist\nDO $$\nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM information_schema.table_constraints \n        WHERE constraint_name = 'crew_location_type_check' \n        AND table_name = 'crew'\n    ) THEN\n        ALTER TABLE crew ADD CONSTRAINT crew_location_type_check \n            CHECK (location_type IN ('ship', 'outpost'));\n    END IF;\nEND $$;