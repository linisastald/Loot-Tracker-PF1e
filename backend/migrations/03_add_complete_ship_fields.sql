-- Add remaining ship sheet fields to complete Pathfinder ship implementation\n-- This migration adds weapons, officers, improvements, and pirate campaign fields\n-- Updated to safely add columns only if they don't exist\n\n-- Function to safely add columns\nCREATE OR REPLACE FUNCTION add_column_if_not_exists(tbl_name text, col_name text, col_definition text)\nRETURNS void AS $$\nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM information_schema.columns \n        WHERE table_name = tbl_name AND column_name = col_name\n    ) THEN\n        EXECUTE format('ALTER TABLE %I ADD COLUMN %I %s', tbl_name, col_name, col_definition);\n    END IF;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- Add pirate campaign specific fields\nSELECT add_column_if_not_exists('ships', 'plunder', 'INTEGER DEFAULT 0');\nSELECT add_column_if_not_exists('ships', 'infamy', 'INTEGER DEFAULT 0');\nSELECT add_column_if_not_exists('ships', 'disrepute', 'INTEGER DEFAULT 0');\n\n-- Add movement and physical details\nSELECT add_column_if_not_exists('ships', 'sails_oars', 'VARCHAR(100)');\nSELECT add_column_if_not_exists('ships', 'sailing_check_bonus', 'INTEGER DEFAULT 0');\n\n-- Add JSON fields for complex data structures\nSELECT add_column_if_not_exists('ships', 'weapons', 'JSONB DEFAULT ''[]''::jsonb');\nSELECT add_column_if_not_exists('ships', 'officers', 'JSONB DEFAULT ''[]''::jsonb');\nSELECT add_column_if_not_exists('ships', 'improvements', 'JSONB DEFAULT ''[]''::jsonb');\nSELECT add_column_if_not_exists('ships', 'cargo_manifest', 'JSONB DEFAULT ''{\"items\": [], \"passengers\": [], \"impositions\": []}''::jsonb');\n\n-- Add additional ship details\nSELECT add_column_if_not_exists('ships', 'ship_notes', 'TEXT');\nSELECT add_column_if_not_exists('ships', 'captain_name', 'VARCHAR(255)');\nSELECT add_column_if_not_exists('ships', 'flag_description', 'TEXT');\n\n-- Add constraints for campaign fields (only if columns exist)\nDO $$\nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM information_schema.table_constraints \n        WHERE constraint_name = 'ships_campaign_stats_check' AND table_name = 'ships'\n    ) AND EXISTS (\n        SELECT 1 FROM information_schema.columns \n        WHERE table_name = 'ships' AND column_name IN ('plunder', 'infamy', 'disrepute')\n        GROUP BY table_name HAVING COUNT(*) = 3\n    ) THEN\n        ALTER TABLE ships ADD CONSTRAINT ships_campaign_stats_check \n            CHECK (plunder >= 0 AND infamy >= 0 AND disrepute >= 0);\n    END IF;\nEND $$;\n\n-- Add indexes for performance on JSON fields (only if columns exist)\nDO $$\nBEGIN\n    IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'ships' AND column_name = 'weapons')\n       AND NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_ships_weapons') THEN\n        CREATE INDEX idx_ships_weapons ON ships USING GIN (weapons);\n    END IF;\n    \n    IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'ships' AND column_name = 'officers')\n       AND NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_ships_officers') THEN\n        CREATE INDEX idx_ships_officers ON ships USING GIN (officers);\n    END IF;\n    \n    IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'ships' AND column_name = 'improvements')\n       AND NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_ships_improvements') THEN\n        CREATE INDEX idx_ships_improvements ON ships USING GIN (improvements);\n    END IF;\n    \n    IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'ships' AND column_name = 'cargo_manifest')\n       AND NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_ships_cargo') THEN\n        CREATE INDEX idx_ships_cargo ON ships USING GIN (cargo_manifest);\n    END IF;\nEND $$;\n\n-- Drop the helper function\nDROP FUNCTION IF EXISTS add_column_if_not_exists(text, text, text);